---
import type { GetStaticPaths } from 'astro';
import { sanityClient } from 'sanity:client';
import imageUrlBuilder from '@sanity/image-url';
import Layout from '../../layouts/Layout.astro';
// import PortableText from '../../components/PortableText.astro'
import SanityImage from '../../components/SanityImage.astro';
import type { Artist } from '../../types/artist';
import Loading from '../../components/Loading.astro';

interface Props {
  artist: Artist;
}

export async function getStaticPaths() {
  const artists = await sanityClient.fetch(`*[_type == "artist"]`);

  return artists.map((artist: Artist) => {
    return {
      params: { slug: artist.slug.current },
      props: { artist },
    };
  });
}

const { artist } = Astro.props as Props;
---

<Layout title={artist.name}>
  <header>
    <div class="container">
      <h1>{artist.name}</h1>

      {
        artist.instagram ? (
          <a
            class="instagram-link"
            href={`https://www.instagram.com/${artist.instagram}`}
            title={`Instagram @${artist.instagram}`}
            target="_blank"
          >
            <SanityImage
              className="portfolio-image"
              mode="cover"
              node={artist.image}
            />
          </a>
        ) : null
      }
    </div>
  </header>

  <article class="container">
    {
      artist.portfolio && (
        <ul class="artist-portfolio">
          {artist.portfolio.map((image) => (
            <li>
              <button
                data-image-source={imageUrlBuilder(sanityClient)
                  .image(image.asset)
                  .url()}
              >
                <SanityImage
                  className="portfolio-image"
                  mode="cover"
                  node={image}
                />
              </button>
            </li>
          ))}
        </ul>
      )
    }

    <div class="portfolio-background">
      <Loading />
      <img class="big-image" />
    </div>
  </article>
</Layout>

<style>
  header {
    background-image: linear-gradient(white, var(--gray-10));
    position: relative;

    & .container {
      align-items: center;
      display: flex;
      justify-content: space-between;
    }

    & h1 {
      color: #2f2f2f;
      text-shadow: 2px 2px 2px white;
      flex-shrink: 1;
      flex-grow: 0;
    }

    & a {
      flex-shrink: 0;
    }
  }

  article {
    padding-block: 2rem;
  }

  ul {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    justify-content: center;
    list-style: none;
    padding: 0;
  }

  li {
    border-radius: 0.25rem;
    overflow: hidden;
  }

  button {
    border: 0;
    padding: 0;
    cursor: pointer;
  }

  .artist-image-container {
  }

  .artist-image-container img {
    margin-inline: auto;
    overflow: hidden;
    border-radius: 50%;
  }

  .portfolio-background {
    display: none;
    position: fixed;
    background-color: rgba(0, 0, 0, 0.8);
    height: 100dvh;
    width: 100dvw;
    inset: 0;
    padding: 2rem;
    z-index: 2000;

    & img {
      max-height: 90dvh;
      z-index: 2004;
    }

    &.open {
      display: grid;
      place-content: center;
    }
  }

  .instagram-link {
    border: 3px solid white;
    box-shadow: 2px 2px 0.375rem rgba(0 0 0 / 0.325);
    border-radius: 50%;
    display: inline-block;
    height: 5rem;
    overflow: hidden;
    overflow: hidden;
    text-indent: -1000px;
    transition: all 0.3s ease-in-out;
    width: 5rem;

    &:hover {
      scale: 1.1;
    }

    /* &.instagram {
      background-image: url('data:image/svg+xml,%3Csvg width="100%25" height="100%25" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;"%3E%3Cpath d="M21,16c0,2.753 -2.247,5 -5,5c-2.753,0 -5,-2.247 -5,-5c0,-2.753 2.247,-5 5,-5c2.753,0 5,2.247 5,5Zm2.695,0c0,-4.257 -3.438,-7.695 -7.695,-7.695c-4.257,0 -7.695,3.438 -7.695,7.695c0,4.257 3.438,7.695 7.695,7.695c4.257,0 7.695,-3.438 7.695,-7.695Zm2.108,-8.007c0,-0.996 -0.8,-1.796 -1.796,-1.796c-0.996,0 -1.797,0.8 -1.797,1.796c0,0.996 0.801,1.797 1.797,1.797c0.996,0 1.796,-0.801 1.796,-1.797l0,0Zm-9.803,-4.296c2.187,0 6.875,-0.176 8.847,0.605c0.683,0.273 1.191,0.606 1.718,1.133c0.527,0.527 0.86,1.035 1.133,1.718c0.781,1.972 0.605,6.66 0.605,8.847c0,2.187 0.176,6.875 -0.605,8.847c-0.273,0.683 -0.606,1.191 -1.133,1.718c-0.527,0.527 -1.035,0.86 -1.718,1.133c-1.972,0.781 -6.66,0.605 -8.847,0.605c-2.187,0 -6.875,0.176 -8.847,-0.605c-0.683,-0.273 -1.191,-0.606 -1.718,-1.133c-0.527,-0.527 -0.86,-1.035 -1.133,-1.718c-0.781,-1.972 -0.605,-6.66 -0.605,-8.847c0,-2.187 -0.176,-6.875 0.605,-8.847c0.273,-0.683 0.606,-1.191 1.133,-1.718c0.527,-0.527 1.035,-0.86 1.718,-1.133c1.972,-0.781 6.66,-0.605 8.847,-0.605l0,0Zm14.999,12.303c0,-2.07 0.019,-4.12 -0.098,-6.191c-0.117,-2.402 -0.664,-4.531 -2.422,-6.288c-1.757,-1.758 -3.886,-2.305 -6.288,-2.422c-2.071,-0.117 -4.121,-0.098 -6.191,-0.098c-2.07,0 -4.12,-0.019 -6.191,0.098c-2.402,0.117 -4.531,0.664 -6.288,2.422c-1.758,1.757 -2.305,3.886 -2.422,6.288c-0.117,2.071 -0.098,4.121 -0.098,6.191c0,2.07 -0.019,4.12 0.098,6.191c0.117,2.402 0.664,4.531 2.422,6.288c1.757,1.758 3.886,2.305 6.288,2.422c2.071,0.117 4.121,0.098 6.191,0.098c2.07,0 4.12,0.019 6.191,-0.098c2.402,-0.117 4.531,-0.664 6.288,-2.422c1.758,-1.757 2.305,-3.886 2.422,-6.288c0.117,-2.071 0.098,-4.121 0.098,-6.191Z" style="fill:%232f2f2f;fill-rule:nonzero;"/%3E%3C/svg%3E');
      background-size: 30px;
    } */
  }
</style>

<script define:vars={{ artist }}>
  const body = document.body;
  const bigImageBg = document.querySelector('.portfolio-background');
  const bigImage = document.querySelector('.big-image');

  const imagesUrls = [];

  document.querySelectorAll('ul.artist-portfolio button').forEach((button) => {
    if (window.innerWidth <= 768) return;

    const imgUrl = button.dataset.imageSource;
    imagesUrls.push(imgUrl);

    button.addEventListener('click', () => {
      if (bigImage && imgUrl) {
        bigImage.src = imgUrl;
        body.dataset.mobileNavOpen = 'true';
        bigImageBg?.classList.add('open');
      }
    });
  });

  function lightboxNext() {
    const currentUrl = bigImage.src;
    const currentIndex = imagesUrls.indexOf(currentUrl);

    if (currentIndex === imagesUrls.length - 1) return;

    bigImage.src = imagesUrls[currentIndex + 1];
  }

  function lightboxPrevious() {
    const currentUrl = bigImage.src;
    const currentIndex = imagesUrls.indexOf(currentUrl);

    if (currentIndex === 0) return;

    bigImage.src = imagesUrls[currentIndex - 1];
  }

  function closeImage() {
    if (!body || !bigImageBg) return;

    body.dataset.mobileNavOpen = 'false';
    bigImageBg.classList.remove('open');
  }

  bigImageBg?.addEventListener('click', () => {
    closeImage();
  });

  document.addEventListener('keydown', (e) => {
    if (body.dataset.mobileNavOpen === 'false' || !body.dataset.mobileNavOpen) {
      return;
    }

    if (e.key === 'ArrowRight') {
      lightboxNext();
    }

    if (e.key === 'ArrowLeft') {
      lightboxPrevious();
    }

    if (e.key === 'Escape') {
      closeImage();
    }
  });
</script>
